---
title: "Продвинутые стратегии кэширования в Next.js"
description: "CDN-кэширование, сегментация по устройствам и ключи кэша на основе локали для современных веб-приложений."
date: "2024-12-20"
tags: ["Next.js", "Caching", "Performance", "Architecture"]
author: "Dmitriy Kairgeldin"
published: true
---

## За пределами простого кэширования

Большинство туториалов покрывают основы — установите заголовок `Cache-Control` и готово. Но в продакшн-приложениях с интернационализацией, адаптивным дизайном и персонализированным контентом кэширование становится значительно сложнее.

## Иерархия кэширования

В современном Next.js приложении кэширование происходит на нескольких уровнях:

1. **Браузерный кэш** — для каждого пользователя
2. **CDN кэш** — общий, на edge-уровне
3. **Кэш приложения** — Next.js Data Cache и Full Route Cache
4. **Кэш базы данных** — кэширование результатов запросов

Каждый уровень имеет свои компромиссы между актуальностью и скоростью.

## Кэширование с учётом устройств

Когда приложение рендерится по-разному для мобильных и десктопных, необходимо сегментировать кэш:

```typescript
export function middleware(request: NextRequest) {
  const response = NextResponse.next();
  const isMobile = request.headers.get('user-agent')?.includes('Mobile');
  
  response.headers.set('X-Device-Type', isMobile ? 'mobile' : 'desktop');
  response.headers.set('Vary', 'X-Device-Type');
  
  return response;
}
```

## Ключевые принципы

1. **Кэшируйте на edge** когда возможно — это самый быстрый уровень
2. **Сегментируйте кэш** по переменным, влияющим на вывод
3. **Используйте stale-while-revalidate** для лучшего UX
4. **Мониторьте cache hit rate** — если он низкий, что-то не так
5. **Имейте механизм ручного сброса** для экстренных случаев
