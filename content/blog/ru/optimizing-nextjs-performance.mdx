---
title: "Оптимизация производительности Next.js: от 60% до 2% нагрузки на сервер"
description: "Глубокий разбор стратегий кэширования и SSR-оптимизаций, которые снизили нагрузку на сервер на 95% в Daribar."
date: "2025-01-15"
tags: ["Next.js", "Performance", "SSR", "Caching"]
author: "Dmitriy Kairgeldin"
published: true
---

## Проблема

Когда я присоединился к Daribar, сервер стабильно работал с нагрузкой 60-80% CPU. Время ответа страниц было непредсказуемым, а во время пиков трафика приложение становилось медленным. Причина? Каждый запрос страницы рендерился на сервере с нуля, без какого-либо уровня кэширования.

## Стратегия

Я разработал многоуровневую стратегию кэширования, которая решала проблему на каждом уровне:

### 1. Кэширование на уровне CDN

Первое и самое значительное изменение — настройка правильных заголовков кэширования для CDN. Мы настроили заголовки `Cache-Control` с `s-maxage`, позволяя статическим и полустатическим страницам обслуживаться прямо с edge-серверов.

```typescript
// Пример: настройка заголовков кэширования для страниц продуктов
export async function generateMetadata({ params }) {
  return {
    other: {
      'Cache-Control': 'public, s-maxage=3600, stale-while-revalidate=86400',
    },
  };
}
```

### 2. Сегментация кэша по устройствам и локалям

Одна из сложных задач — наши страницы рендерились по-разному в зависимости от типа устройства и локали пользователя. Мы реализовали сегментацию ключей кэша используя заголовок `Vary` и кастомные ключи.

Это означало, что мобильный пользователь на русском и десктопный пользователь на английском получали каждый свою кэшированную версию.

### 3. Оптимизация Next.js SSR

Мы перестроили загрузку данных, чтобы максимально использовать встроенное кэширование Next.js:

- **Статические страницы** предварительно рендерились при сборке
- **Динамические страницы** использовали ISR с подходящими интервалами ревалидации
- **Пользовательский контент** загружался на клиенте

## Результаты

- **Нагрузка на сервер упала с 60-80% до 2-5%**
- **TTFB улучшился на 85%**
- **Lighthouse-оценки достигли 90+**
- **Расходы на инфраструктуру значительно снизились**

## Ключевые выводы

1. **Кэшируйте всё, что можно** — контент меняется реже, чем вы думаете
2. **Сегментируйте кэш** — не отдавайте одну и ту же страницу всем
3. **Измеряйте до и после** — без метрик вы не докажете эффект
4. **Начинайте с больших побед** — CDN-кэширование решило 70% проблемы
